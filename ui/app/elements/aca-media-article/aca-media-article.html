<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="aca-media-article">

  <template>

    <style>
      .mediaContainer {
        /*padding: 0.3em;*/
        /*display: inline-block;*/
        margin: 0.3em;
        display: inline-block;
        max-width: 400px;
      }

      .image-150 {
        width: 150px;
        height: 150px;
      }
    </style>

    <h1>
      Aca media article:[[contentKey]]
    </h1>

    <h4>
      Fields:
    </h4>
    <ul>
      <template is="dom-repeat" items="[[fields]]">
        <li>[[item.key]]: [[item.value]]</li>
      </template>
    </ul>

    <div class="">
      <h4 class="flex">Media</h4>
      <h6>Items: [[media.length]]</h6>
    </div>

    <div class="layout horizontal wrap">
      <template is="dom-repeat" items="[[media]]">
        <paper-card id="mediaContainer" class="mediaContainer">
          <div class="card-content">
            <div class="layout horizontal">
              <template is="dom-if" if="[[_isImage(item)]]">
                <iron-image src$="[[item.url]]" class="image-150" sizing="cover" fade></iron-image>
              </template>

              <template is="dom-if" if="[[_isAudio(item)]]">
                <div class="image-150">
                  <iron-image src$="[[audioImage()]]"/>
                  <audio id="mediaControl">
                    <source src$="[[item.url]]">
                    Your browser does not support the audio tag.
                  </audio>
                </div>
              </template>

              <template is="dom-if" if="[[_isVideo(item)]]">
                <div class="image-150">
                  <video id="mediaControl" width="150" height="84">
                    <source src$="[[item.url]]">
                    Your browser does not support the html5 video tag.
                  </video>
                </div>
              </template>

              <div style="width:250px; margin-left: 0.3em;">
                <div hidden$="[[item.caption]]">
                  (No Caption)
                </div>
                <div hidden$="[[!item.caption]]">
                  [[item.caption]]
                </div>
              </div>
            </div>
          </div>

          <div class="card-actions">
            <template is="dom-if" if="[[_isAudioOrVideo(item)]]">
              <div class="horizontal layout">
                <span class="flex"></span>
                <paper-icon-button id="mediaButton" icon="av:play-circle-outline" on-click="onTogglePlay"></paper-icon-button>
                <span class="flex"></span>
              </div>
            </template>
          </div>
        </paper-card>
      </template>

      <div hidden$="[[_hasMedia]]">
        <p>
          <em>No Media</em>
        </p>
      </div>

    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'aca-media-article',

        properties: {
          contentKey: {
            type: String,
            value: undefined,
            //observer: 'contentKeyChanged'
          },

          article: {
            type: Object,
            value: undefined
          },

          fields: {
            type: Array,
            value: []
          },

          media: {
            type: Array,
            value: []
          },

          _hasMedia: {
            type: Boolean,
            value: false,
            notify: true
          }

        },

        audioImage: function() {
          return 'images/sonata.png';
        },

        lookup: function(contentKey) {
          if (_.hasIn(app, 'params.contentKey')) {
            this.set('contentKey', app.params.contentKey);
          } else if (contentKey) {
            page.redirect('/article/' + contentKey);
            return;
          } else {
            console.warn('Could not get contentKey from either parameter or path.');
            return;
          }

          console.debug('lookup: ', this.contentKey);
          this.contentKeyChanged(this.contentKey);
        },

        contentKeyChanged: function(newContentKey) {
          app.showToast('new contentKey: {contentKey}', {contentKey: newContentKey});

          this.reset();

          app.lookup(newContentKey, function(response) {
            console.info('Got lookup response: ', response);

            this.article = response.data.content[0].article;
            this.metaData = response.data.content[0].article.metaData;

            const urlForReference = (mediaItem) => {
              if (mediaItem.mediaType === 'Image') {
                return mediaItem.references[0].imageURL;
              } else if (mediaItem.mediaType === 'Audio') {
                return mediaItem.references[0].url;
              } else if (mediaItem.mediaType === 'Video') {
                return mediaItem.references[0].url;
              }
            };

            const pushToMedia = host => (mediaItem) => {
              console.info('pushTomedia: host: %o', host);
              if (!_.isEmpty(mediaItem.references)) {
                let item = {
                  caption: mediaItem.caption,
                  type: mediaItem.mediaType,
                  url: urlForReference(mediaItem)
                };
                console.info('pushing media item: ', item);
                host.push('media', item);
              }
            };

            const pushToTuple = host => (key) => {
              console.info('pushToTuple: host: %o, key: %s', host, key);

              let value = host.article[key];

              if (value !== undefined && value !== null && !_.isEmpty(value)) {
                host.push('fields', {key: key, value: value});
                if ('mediaList' === key) {
                  _.each(value.mediaItems, pushToMedia(host));
                }
              }
            };

            _.keys(this.article).forEach(pushToTuple(this));

            this.set('_hasMedia', !_.isEmpty(this.media));

          }.bind(this), function(err) {
            app.showToast('Error during lookup: {err}', {err: err}, true);
          });

        },

        reset: function() {
          this.article = undefined;
          this.fields = [];
          this.media = [];
          this._hasMedia = false;
        },

        togglePlay: function(e) {
          var audioPlayer = Polymer.dom(e.target.parentNode).querySelector('audio');
          console.log('toggle audio play: ', audioPlayer);

          if (audioPlayer.paused) {
            audioPlayer.play();
          } else {
            audioPlayer.pause();
          }
        },

        onTogglePlay: function(e) {

          const stylePauseIcon = 'av:pause-circle-outline';
          const stylePlayIcon = 'av:play-circle-outline';
          const mediaControlId = '#mediaControl';
          const mediaButtonId = 'paper-icon-button#mediaButton';

          const findNodeUp = (id, node) => {
            const traverseUp = (node) => {
              if (node.parentNode === null) {
                return null;
              } else {
                return (node.id === id) ? node : traverseUp(node.parentNode);
              }
            };
            return traverseUp(node);
          };

          const toggleSteps = (control, button) => {
            if (!(control && button)) {
              console.error('Both control and button is required.');
              return;
            }

            if (control.paused) {
              control.play();
            } else {
              control.pause();
            }
            Polymer.dom(button).setAttribute('icon', (control.paused ? stylePlayIcon : stylePauseIcon  ));
          };

          const mediaContainer = findNodeUp('mediaContainer', e.target);

          if (mediaContainer) {
            const mediaControl = Polymer.dom(mediaContainer).querySelector(mediaControlId);
            const mediaButton = Polymer.dom(mediaContainer).querySelector(mediaButtonId);
            toggleSteps(mediaControl, mediaButton);
          }
        },

        _isType: function(item, type) {
          return item.type === type;
        },

        _isAudioOrVideo: function(item) {
          return _.some(['Audio','Video'], function(t) {
            return t === item.type;
          });
        },

        _isImage: function(item) {
          return this._isType(item, 'Image');
        },

        _isAudio: function(item) {
          return this._isType(item, 'Audio');
        },

        _isVideo: function(item) {
          return this._isType(item, 'Video');
        },

      });
    })();
  </script>

</dom-module>
