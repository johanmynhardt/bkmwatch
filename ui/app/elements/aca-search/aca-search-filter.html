<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="aca-search-filter">
  <style>
    :host {
      display: block;
    }

    paper-input {
      margin-right: 0.5em;
    }

    /*paper-input.wider {*/
      /*width: 25em;*/
    /*}*/
  </style>

  <template>
    <iron-a11y-keys id="keys" target="[[target]]" keys="enter" on-keys-pressed="_fireSearch"></iron-a11y-keys>

    <!--     form with start and end date -->
    <!--     clear button visible when either start or end is specified -->
    <div id="wrapper">
      <template is="dom-if" if="[[displayFilter]]">

        <paper-material elevation="1" style="padding: 1em; margin-bottom: 1em;">

          <aca-autocomplete-input title="Selected Titles:" label="Enter new title"
                                  value="{{titleFilter}}" for="titleFilter"
                                  selected="{{selectedTitles}}"
                                  db="titles"
                                  selection-listener="[[titleSelected()]]"
                                  ></aca-autocomplete-input>

          <aca-autocomplete-input title="Selected Sections:" label="Enter new section"
                                  value="{{sectionFilter}}" for="sectionFilter"
                                  selected="{{selectedSections}}"
                                  db="sections"
                                  min-expand="1"
                                  ></aca-autocomplete-input>

          <div class="vertical layout">
            <div class="horizontal layout">
              <paper-input id="startDate" class="wider" label="Start Date" on-click="_displayPickerStart" value="[[_startDateDisplay]]"></paper-input>
              <paper-input id="endDate" class="wider" label="End Date" on-click="_displayPickerEnd" value="[[_endDateDisplay]]"></paper-input>
            </div>
            <p></p>
            <div class="horizontal layout">
              <span class="flex"></span>
              <span class="flex"></span>
              <span class="flex"></span>
              <span class="flex">
              </span>
              <paper-button on-click="_clearValues" hidden$="{{!_showClearValues}}" title="Clear fields">
                <iron-icon icon="clear"></iron-icon>
                Clear
              </paper-button>
              <paper-button class="" on-click="_fireSearch" noink raised>
                <iron-icon icon="search"></iron-icon>
                Search
              </paper-button>

            </div>
          </div>
        </paper-material>

      <!-- ARTICLE PARAMETERS -->
      <template is="dom-if" if="[[_showArticleParameters]]">
<!--         <aca-search-article-parameters></aca-search-article-parameters> -->
      </template>
    </template>
    </div>

    <content></content>

    <!-- Dialog -->
    <paper-dialog id="dialog" class="paper-date-picker-dialog" modal opened="{{_dialogOpened}}">
      <paper-date-picker id="picker" narrow></paper-date-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Select</paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'aca-search-filter',

        /**
         * aca-search-filter properties
         */
        properties: {
          displayFilter: {
            type: Boolean,
            value: false,
            notify: true
          },
          startDate: {
            type: Object,
            notify: true,
            observer: '_startDateChanged'
          },
          _startDateDisplay: {
            type: String,
            notify: true
          },
          endDate: {
            type: Object,
            notify: true,
            observer: '_endDateChanged'
          },
          _endDateDisplay: {
            type: String,
            notify: true
          },
          titleFilter: {
            type: Object,
            notify: true,
            observer: '_filterChanged'
          },
          sectionFilter: {
            type: Object,
            notify: true,
            observer: '_filterChanged'
          },
          searchType: {
            type: String,
            value: 'type-media',
            notify: true,
            observer: '_changeSearchType'
          },

          _dateValueSelected: {
            type: Boolean,
            value: false
          },

          selectedTitles: {
            type: Array,
            value: []
          },

          selectedSections: {
            type: Array,
            value: []
          },

          _showArticleParameters: {
            type: Boolean,
            value: false,
            notify: true
          },
          _showClearValues: {
            type: Boolean,
            value: false,
            notify: true
          },
          _dialogOpened: {
            type: Boolean,
            value: false,
            notify: true,
            observer: '_openedChanged'
          },
          _for: {
            type: String,
            value: undefined
          },
          target: {
            type: Object,
            value: function() {
              let target = this.$.wrapper;
              console.log('target: ', target);
              return target;
            },
            notify: true
          },
        },

        titleSelected: function() {
          return {
            onSelect: function(title) {
              console.log('titleSelected: ', title);
              app.bootstrap.fetchEditions(title);
            }
          };
        },

        get titles() {
          return this.selectedTitles;
        },

        get sections() {
          return this.selectedSections;
        },

        _changeSearchType: function(newSearchType) {
          console.log('change search type: ', newSearchType);
          this._showArticleParameters = _.isEqual(newSearchType, 'type-article');
        },

        _displayPickerStart: function() {
          this._for = 'start';
          this.$.dialog.open();
        },

        _displayPickerEnd: function() {
          this._for = 'end';
          this.$.dialog.open();
        },

        _filterChanged: function(newValue) {
          if (!_.isEmpty(newValue)) {
            this._setDirty();
          }
        },

        _isSearchType: function(type) {
          return _.isEqual(this.searchType, type);
        },

        _openedChanged: function(newValue) {
          if (!newValue && this.$.dialog.closingReason.confirmed) {
            console.log('confirmed: for(%s): ', this._for, this.$.picker.date);
            if (_.isEqual(this._for, 'start')) {
              this.startDate = this.$.picker.date;
            } else if (_.isEqual(this._for, 'end')) {
              this.endDate = this.$.picker.date;
            }
          }
        },

        _clearValues: function() {
          this.startDate = this.endDate = this._startDateDisplay = this._endDateDisplay = undefined;
          this.titleFilter = this.sectionFilter = undefined;
          this.set('_showClearValues', false);
        },

        _setDirty: function() {
          if (!this._showClearValues) {
            this.set('_showClearValues', true);
          }
        },

        _startDateChanged: function(newValue) {
          if (_.isDate(newValue)) {
            this.startDate = newValue;
            this._startDateDisplay = newValue.toDateString();
            if (_.isUndefined(this.endDate)) {
              this.endDate = newValue;
            }
            this._setDirty();
          } else {
            this.startDate = undefined;
          }
        },

        _endDateChanged: function(newValue) {
          if (_.isDate(newValue)) {
            this.endDate = newValue;
            this._endDateDisplay = newValue.toDateString();
            this._setDirty();
          } else {
            this.endDate = undefined;
          }
        },

        _fireSearch: function() {
          this.fire('iron-signal', {
            name: 'do-search',
            data: 'ping'
          });
        }
      });
    })();
  </script>
</dom-module>
