<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="simple-image-list">
  <style>
    :host {
      display: block;
    }

    paper-material {
      padding: 1em;
      margin: 0.5em;
    }

    paper-dialog#copyDialog {
      width: 600px;
    }
  </style>

  <template>
    <paper-toolbar>
      <h2>{{title}} <template is="dom-if" if="{{forResult}}">for '{{forResult}}'</template> <template is="dom-if" if="{{showResultCount}}"> ([[items.length]])</template></h2>
      <div class="flex"></div>
      <template is="dom-if" if="{{canShowCopy}}">
        <template is="dom-if" if="{{canSendToInitiator}}"><paper-icon-button icon="input" alt="baobab-insert" title="Insert back in Baobab" on-click="sendToInitiator"></paper-icon-button></template>
        <paper-icon-button icon="content-copy" alt="content-copy" title="Copy to clipboard" on-click="showDialogForCopy"></paper-icon-button>
      </template>
    </paper-toolbar>
    <div class="flex layout center">
      <template is="dom-repeat" items="{{items}}" as="item">
        <simple-image-item config="[[config]]" item="[[item]]" on-click="toggleImage"></simple-image-item>
      </template>

      <array-selector id="selector" items="{{items}}" selected="{{selected}}"></array-selector>
    </div>

    <paper-dialog id="copyDialog" auto-fit-on-attach>
      <h2 width="500">Images as Tags</h2>
      <div>
        <!-- <paper-input id="copyContent" label="HTML for selected images" readonly focussed multiline rows="10"></paper-input> -->
        <code id="copyContent">[[copyContent]]</code>
        <!-- <paper-textarea id="copyContent" label="HTML for selected images" readonly focussed multiline rows="5" onclick="document.getElementById('textarea').select();"></paper-textarea> -->
      </div>

      <div class="buttons">
        <paper-button onclick="document.execCommand('copy'); alert('copied selection')">Copy</paper-button>
        <paper-button dialog-dismiss>Close</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'simple-image-list',
        properties: {
          config: {
            type: Object
          },
          item: {
            type: String,
            value: '(not set)'
          },
          items: {
            type: Array,
            value: [],
            notify: true
          },
          title: {
            type: String,
            value: 'Results'
          },
          showResultCount: {
            type: Boolean,
            value: false,
            notify: true
          },
          selected: {
            type: Array,
            value: function() {
              return [];
            },
            notify: true
          },
          canShowCopy: {
            type: Boolean,
            value: false,
            notify: true
          },
          canSendToInitiator: {
            type: Boolean,
            value: false,
            notify: true
          },
          copyContent: {
            type: String,
            value: '',
            notify: true
          }
        },
        toggleImage: function(e) {
          console.log('toggleImage');
          var model = e.model;
          model.set('item.selected', !model.item.selected);

          if (this.selected.indexOf(model.item) > -1) {
            var idx = this.selected.indexOf(model.item);
            this.selected.splice(idx, 1);
          } else {
            this.selected.push(model.item);
          }
          this.canShowCopy = this.selected.length > 0;
          if (window.opener) {
            this.canSendToInitiator = true;
          }
        },
        showDialogForCopy: function() {
          var imgTags = '';

          this.selected.forEach(function(item) {
            imgTags += '<img src="' + item.imageURL + '"/><br/>\n';
          });

          //this.$.copyContent.innerHTML = imgTags;
          this.copyContent = imgTags;

          var copyDialog = this.$.copyDialog;
          copyDialog.open();

        },
        sendToInitiator: function() {
          if (window.opener) {
            var message = JSON.stringify({
              request: 'selected',
              items: this.selected
            });
            if (message) {
              console.info('sending selected: %s', message);
              window.opener.postMessage(message, '*');
            } else {
              console.warn('no value to send.');
            }
          } else {
            console.error('Can not send message. Window has no opener.');
          }
        },
        itemsChanged: function() {
          console.log('items changed');
        }
      });
    })();
  </script>
</dom-module>
