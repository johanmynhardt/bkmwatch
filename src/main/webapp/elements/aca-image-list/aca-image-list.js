'use strict';

(function () {
  'use strict';

  Polymer({
    is: 'aca-image-list',
    properties: {
      item: {
        type: String,
        value: '(not set)'
      },
      articles: {
        type: Array,
        notify: true
      },
      title: {
        type: String,
        value: 'Results'
      },
      showResultCount: {
        type: Boolean,
        value: false,
        notify: true
      },
      seltd: {
        type: Object,
        value: function value() {
          return [];
        },
        //readOnly: true,
        reflectToAttribute: true
      },
      canShowCopy: {
        type: Boolean,
        value: false,
        notify: true
      },
      canSendToInitiator: {
        type: Boolean,
        value: false,
        notify: true
      },
      hasSelection: {
        type: Boolean,
        value: false,
        notify: true
      },
      showSelection: {
        type: Boolean,
        value: false,
        notify: true
      },
      _imageArticles: {
        type: Array,
        value: [],
        notify: true
      }
    },

    observers: ['selectedChanged(selected.*)', 'selectedChanged(seltd.*)'],

    getMediaItemReferenceAt: function getMediaItemReferenceAt(mediaItem, idx) {
      var reference = mediaItem.references[idx];
      return {
        caption: mediaItem.caption,
        altText: reference.alternateText,
        imageURL: reference.imageURL,
        width: reference.width,
        height: reference.height,
        mimeType: reference.mimeType,
        source: reference.imageSource,
        selected: false
      };
    },

    toggleItem: function toggleItem(e) {

      console.info('toggleItem: %o', e.detail);

      var image = e.detail;
      console.log('toggle image: ', image);

      image.selected = !image.selected;

      if (image.selected) {
        this._addItem(image);
      } else {
        this._removeItem(image);
      }

      var tmp = this.setld;
      this.setld = [];
      this.setld = tmp;
      this.selected = tmp;
      this.notifyPath('setld', this.setld);
      this.notifyPath('selected', this.setld);
      Polymer.dom.flush();
    },

    _hasItems: function _hasItems(collection) {
      return collection.length > 0;
    },

    _removeItem: function _removeItem(toRemove) {
      var index = this.seltd.indexOf(toRemove);
      this.splice('seltd', index, 1);
    },

    _addItem: function _addItem(toAdd) {
      this.push('seltd', toAdd);
    },

    hasSelection: function hasSelection() {
      var hasSelection = this.seltd.length > 0;
      console.log('hasSelection: "', hasSelection);
      return hasSelection;
    },

    /**
     * Return the selected items back to the parent window.
    */
    sendToInitiator: function sendToInitiator() {
      if (window.opener) {
        var message = JSON.stringify({
          request: 'selected',
          items: this.selected
        });
        if (message) {
          console.info('sending selected: %s', message);
          window.opener.postMessage(message, '*');
        } else {
          console.warn('no value to send.');
        }
      } else {
        console.error('Can not send message. Window has no opener.');
      }
    },

    /**
     * JSON Stringified representation of the given item.
     */
    _itemAsString: function _itemAsString(item) {
      return JSON.stringify(item, null, ' ');
    },

    heading: function heading(metaData) {
      if (metaData.abstractSummary) {
        return metaData.abstractSummary;
      } else {
        return 'No Heading';
      }
    },

    dateFromLong: function dateFromLong(longDate) {
      return new Date(longDate).toDateString();
    },

    itemsForSelection: function itemsForSelection(_itemsForSelection) {
      var r = this;
      _itemsForSelection.forEach(function (item) {
        console.log('itemForSelection: ', r.getMediaItemReferenceAt(item.mediaItems[0], 0));
      });
    },

    selectedChanged: function selectedChanged(ch) {
      console.log('ch: ', ch);
      if (ch.path === 'seltd.length') {
        this.hasSelection = ch.value > 0;
        var data = ch.base;
        this.showSelection = this.hasSelection;
        this.fire('iron-signal', { name: 'selection-changed', data: data });
      }
    },

    searchLoadingChanged: function searchLoadingChanged(e) {
      if (!e.detail.loading) {
        this.set('_imageArticles', this._imagesFromArticles(this.articles));
      }
    },

    _imagesFromArticles: function _imagesFromArticles(articles) {
      var allImages = [];
      articles.forEach(function (article) {
        allImages = _.concat(allImages, this._filterType(article, 'Image'));
      }.bind(this));
      return allImages;
    },

    _filterType: function _filterType(article, mediaType) {

      if (article.mediaItems === undefined) {
        return;
      }

      // .mediaItems

      console.log('mediaItems: ', article.mediaItems.length);

      var forCollection = _.curry(function (bucket, item) {
        if (_.isEqual(item.mediaType, mediaType)) {
          item.metaData = article.metaData;
          var imgRef = this.getMediaItemReferenceAt(item, 0);

          if (imgRef.imageURL !== undefined && imgRef.imageURL.length > 0) {
            bucket.push(item);
          } else {
            console.warn('no imgURL in imgRef: ', imgRef);
          }
        }
      }.bind(this));

      var imageItems = [];
      article.mediaItems.forEach(forCollection(imageItems));

      return imageItems;
    },

    _showImageDetails: function _showImageDetails(e) {
      this.$.metaDialog.displayFor(e.detail);
    }
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnRzL2FjYS1pbWFnZS1saXN0L2FjYS1pbWFnZS1saXN0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsQ0FBQyxZQUFXO0FBQ047O0FBRUEsVUFBUTtBQUNOLFFBQUksZ0JBREU7QUFFTixnQkFBWTtBQUNWLFlBQU07QUFDSixjQUFNLE1BREY7QUFFSixlQUFPO0FBRkgsT0FESTtBQUtWLGdCQUFVO0FBQ1IsY0FBTSxLQURFO0FBRVIsZ0JBQVE7QUFGQSxPQUxBO0FBU1YsYUFBTztBQUNMLGNBQU0sTUFERDtBQUVMLGVBQU87QUFGRixPQVRHO0FBYVYsdUJBQWlCO0FBQ2YsY0FBTSxPQURTO0FBRWYsZUFBTyxLQUZRO0FBR2YsZ0JBQVE7QUFITyxPQWJQO0FBa0JWLGFBQU87QUFDTCxjQUFNLE1BREQ7QUFFTCxlQUFPLGlCQUFXO0FBQUMsaUJBQU8sRUFBUDtBQUFXLFNBRnpCO0FBR0w7QUFDQSw0QkFBb0I7QUFKZixPQWxCRztBQXlCVixtQkFBYTtBQUNYLGNBQU0sT0FESztBQUVYLGVBQU8sS0FGSTtBQUdYLGdCQUFRO0FBSEcsT0F6Qkg7QUE4QlYsMEJBQW9CO0FBQ2xCLGNBQU0sT0FEWTtBQUVsQixlQUFPLEtBRlc7QUFHbEIsZ0JBQVE7QUFIVSxPQTlCVjtBQW1DVixvQkFBYztBQUNaLGNBQU0sT0FETTtBQUVaLGVBQU8sS0FGSztBQUdaLGdCQUFRO0FBSEksT0FuQ0o7QUF3Q1YscUJBQWU7QUFDYixjQUFNLE9BRE87QUFFYixlQUFPLEtBRk07QUFHYixnQkFBUTtBQUhLLE9BeENMO0FBNkNWLHNCQUFnQjtBQUNkLGNBQU0sS0FEUTtBQUVkLGVBQU8sRUFGTztBQUdkLGdCQUFRO0FBSE07QUE3Q04sS0FGTjs7QUFzRE4sZUFBVyxDQUNULDZCQURTLEVBQ3NCLDBCQUR0QixDQXRETDs7QUEwRE4sNkJBQXlCLGlDQUFTLFNBQVQsRUFBb0IsR0FBcEIsRUFBeUI7QUFDaEQsVUFBSSxZQUFZLFVBQVUsVUFBVixDQUFxQixHQUFy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QUFTLE9BQVQsRUFBa0IsU0FBbEIsRUFBNkI7O0FBRXhDLFVBQUksUUFBUSxVQUFSLEtBQXVCLFNBQTNCLEVBQXNDO0FBQ3BDO0FBQ0Q7O0FBRUQ7O0FBRUEsY0FBUSxHQUFSLENBQVksY0FBWixFQUE0QixRQUFRLFVBQVIsQ0FBbUIsTUFBL0M7O0FBRUEsVUFBSSxnQkFBZ0IsRUFBRSxLQUFGLENBQVEsVUFBUyxNQUFULEVBQWlCLElBQWpCLEVBQXVCO0FBQ2pELFlBQUksRUFBRSxPQUFGLENBQVUsS0FBSyxTQUFmLEVBQTBCLFNBQTFCLENBQUosRUFBMEM7QUFDeEMsZUFBSyxRQUFMLEdBQWdCLFFBQVEsUUFBeEI7QUFDQSxjQUFJLFNBQVMsS0FBSyx1QkFBTCxDQUE2QixJQUE3QixFQUFtQyxDQUFuQyxDQUFiOztBQUVBLGNBQUksT0FBTyxRQUFQLEtBQW9CLFNBQXBCLElBQWlDLE9BQU8sUUFBUCxDQUFnQixNQUFoQixHQUF5QixDQUE5RCxFQUFpRTtBQUMvRCxtQkFBTyxJQUFQLENBQVksSUFBWjtBQUNELFdBRkQsTUFFTztBQUNMLG9CQUFRLElBQVIsQ0FBYSx1QkFBYixFQUFzQyxNQUF0QztBQUNEO0FBQ0Y7QUFDRixPQVgyQixDQVcxQixJQVgwQixDQVdyQixJQVhxQixDQUFSLENBQXBCOztBQWFBLFVBQUksYUFBYSxFQUFqQjtBQUNBLGNBQVEsVUFBUixDQUFtQixPQUFuQixDQUEyQixjQUFjLFVBQWQsQ0FBM0I7O0FBRUEsYUFBTyxVQUFQO0FBQ0QsS0FwTks7O0FBc05OLHVCQUFtQiwyQkFBUyxDQUFULEVBQVk7QUFDN0IsV0FBSyxDQUFMLENBQU8sVUFBUCxDQUFrQixVQUFsQixDQUE2QixFQUFFLE1BQS9CO0FBQ0Q7QUF4TkssR0FBUjtBQTBORCxDQTdOTCIsImZpbGUiOiJlbGVtZW50cy9hY2EtaW1hZ2UtbGlzdC9hY2EtaW1hZ2UtbGlzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpIHtcbiAgICAgICd1c2Ugc3RyaWN0JztcblxuICAgICAgUG9seW1lcih7XG4gICAgICAgIGlzOiAnYWNhLWltYWdlLWxpc3QnLFxuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgaXRlbToge1xuICAgICAgICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgICAgICAgdmFsdWU6ICcobm90IHNldCknXG4gICAgICAgICAgfSxcbiAgICAgICAgICBhcnRpY2xlczoge1xuICAgICAgICAgICAgdHlwZTogQXJyYXksXG4gICAgICAgICAgICBub3RpZnk6IHRydWVcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRpdGxlOiB7XG4gICAgICAgICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICAgICAgICB2YWx1ZTogJ1Jlc3VsdHMnXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzaG93UmVzdWx0Q291bnQ6IHtcbiAgICAgICAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICAgICAgICB2YWx1ZTogZmFsc2UsXG4gICAgICAgICAgICBub3RpZnk6IHRydWVcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNlbHRkOiB7XG4gICAgICAgICAgICB0eXBlOiBPYmplY3QsXG4gICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7cmV0dXJuIFtdO30sXG4gICAgICAgICAgICAvL3JlYWRPbmx5OiB0cnVlLFxuICAgICAgICAgICAgcmVmbGVjdFRvQXR0cmlidXRlOiB0cnVlLFxuICAgICAgICAgICAgLy9ub3RpZnk6IHRydWVcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNhblNob3dDb3B5OiB7XG4gICAgICAgICAgICB0eXBlOiBCb29sZWFuLFxuICAgICAgICAgICAgdmFsdWU6IGZhbHNlLFxuICAgICAgICAgICAgbm90aWZ5OiB0cnVlXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjYW5TZW5kVG9Jbml0aWF0b3I6IHtcbiAgICAgICAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICAgICAgICB2YWx1ZTogZmFsc2UsXG4gICAgICAgICAgICBub3RpZnk6IHRydWVcbiAgICAgICAgICB9LFxuICAgICAgICAgIGhhc1NlbGVjdGlvbjoge1xuICAgICAgICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgICAgICAgIHZhbHVlOiBmYWxzZSxcbiAgICAgICAgICAgIG5vdGlmeTogdHJ1ZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2hvd1NlbGVjdGlvbjoge1xuICAgICAgICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgICAgICAgIHZhbHVlOiBmYWxzZSxcbiAgICAgICAgICAgIG5vdGlmeTogdHJ1ZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgX2ltYWdlQXJ0aWNsZXM6IHtcbiAgICAgICAgICAgIHR5cGU6IEFycmF5LFxuICAgICAgICAgICAgdmFsdWU6IFtdLFxuICAgICAgICAgICAgbm90aWZ5OiB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIG9ic2VydmVyczogW1xuICAgICAgICAgICdzZWxlY3RlZENoYW5nZWQoc2VsZWN0ZWQuKiknLCAnc2VsZWN0ZWRDaGFuZ2VkKHNlbHRkLiopJ1xuICAgICAgICBdLFxuXG4gICAgICAgIGdldE1lZGlhSXRlbVJlZmVyZW5jZUF0OiBmdW5jdGlvbihtZWRpYUl0ZW0sIGlkeCkge1xuICAgICAgICAgIHZhciByZWZlcmVuY2UgPSBtZWRpYUl0ZW0ucmVmZXJlbmNlc1tpZHhdO1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjYXB0aW9uOiBtZWRpYUl0ZW0uY2FwdGlvbixcbiAgICAgICAgICAgIGFsdFRleHQ6IHJlZmVyZW5jZS5hbHRlcm5hdGVUZXh0LFxuICAgICAgICAgICAgaW1hZ2VVUkw6IHJlZmVyZW5jZS5pbWFnZVVSTCxcbiAgICAgICAgICAgIHdpZHRoOiByZWZlcmVuY2Uud2lkdGgsXG4gICAgICAgICAgICBoZWlnaHQ6IHJlZmVyZW5jZS5oZWlnaHQsXG4gICAgICAgICAgICBtaW1lVHlwZTogcmVmZXJlbmNlLm1pbWVUeXBlLFxuICAgICAgICAgICAgc291cmNlOiByZWZlcmVuY2UuaW1hZ2VTb3VyY2UsXG4gICAgICAgICAgICBzZWxlY3RlZDogZmFsc2VcbiAgICAgICAgICB9O1xuICAgICAgICB9LFxuXG4gICAgICAgIHRvZ2dsZUl0ZW06IGZ1bmN0aW9uKGUpIHtcblxuICAgICAgICAgIGNvbnNvbGUuaW5mbygndG9nZ2xlSXRlbTogJW8nLCBlLmRldGFpbCk7XG5cbiAgICAgICAgICB2YXIgaW1hZ2UgPSBlLmRldGFpbDtcbiAgICAgICAgICBjb25zb2xlLmxvZygndG9nZ2xlIGltYWdlOiAnLCBpbWFnZSk7XG5cbiAgICAgICAgICBpbWFnZS5zZWxlY3RlZCA9ICFpbWFnZS5zZWxlY3RlZDtcblxuICAgICAgICAgIGlmIChpbWFnZS5zZWxlY3RlZCkge1xuICAgICAgICAgICAgdGhpcy5fYWRkSXRlbShpbWFnZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3JlbW92ZUl0ZW0oaW1hZ2UpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHZhciB0bXAgPSB0aGlzLnNldGxkO1xuICAgICAgICAgIHRoaXMuc2V0bGQgPSBbXTtcbiAgICAgICAgICB0aGlzLnNldGxkID0gdG1wO1xuICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB0bXA7XG4gICAgICAgICAgdGhpcy5ub3RpZnlQYXRoKCdzZXRsZCcsIHRoaXMuc2V0bGQpO1xuICAgICAgICAgIHRoaXMubm90aWZ5UGF0aCgnc2VsZWN0ZWQnLCB0aGlzLnNldGxkKTtcbiAgICAgICAgICBQb2x5bWVyLmRvbS5mbHVzaCgpO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9oYXNJdGVtczogZnVuY3Rpb24oY29sbGVjdGlvbikge1xuICAgICAgICAgIHJldHVybiBjb2xsZWN0aW9uLmxlbmd0aCA+IDA7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX3JlbW92ZUl0ZW06IGZ1bmN0aW9uKHRvUmVtb3ZlKSB7XG4gICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5zZWx0ZC5pbmRleE9mKHRvUmVtb3ZlKTtcbiAgICAgICAgICB0aGlzLnNwbGljZSgnc2VsdGQnLCBpbmRleCwgMSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2FkZEl0ZW06IGZ1bmN0aW9uKHRvQWRkKSB7XG4gICAgICAgICAgdGhpcy5wdXNoKCdzZWx0ZCcsIHRvQWRkKTtcbiAgICAgICAgfSxcblxuICAgICAgICBoYXNTZWxlY3Rpb246IGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHZhciBoYXNTZWxlY3Rpb24gPSB0aGlzLnNlbHRkLmxlbmd0aCA+IDA7XG4gICAgICAgICAgY29uc29sZS5sb2coJ2hhc1NlbGVjdGlvbjogXCInLCBoYXNTZWxlY3Rpb24pO1xuICAgICAgICAgIHJldHVybiBoYXNTZWxlY3Rpb247XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybiB0aGUgc2VsZWN0ZWQgaXRlbXMgYmFjayB0byB0aGUgcGFyZW50IHdpbmRvdy5cbiAgICAgICAgKi9cbiAgICAgICAgc2VuZFRvSW5pdGlhdG9yOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICBpZiAod2luZG93Lm9wZW5lcikge1xuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgIHJlcXVlc3Q6ICdzZWxlY3RlZCcsXG4gICAgICAgICAgICAgIGl0ZW1zOiB0aGlzLnNlbGVjdGVkXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuaW5mbygnc2VuZGluZyBzZWxlY3RlZDogJXMnLCBtZXNzYWdlKTtcbiAgICAgICAgICAgICAgd2luZG93Lm9wZW5lci5wb3N0TWVzc2FnZShtZXNzYWdlLCAnKicpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdubyB2YWx1ZSB0byBzZW5kLicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdDYW4gbm90IHNlbmQgbWVzc2FnZS4gV2luZG93IGhhcyBubyBvcGVuZXIuJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBKU09OIFN0cmluZ2lmaWVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBpdGVtLlxuICAgICAgICAgKi9cbiAgICAgICAgX2l0ZW1Bc1N0cmluZzogZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShpdGVtLCBudWxsLCAnICcpO1xuICAgICAgICB9LFxuXG4gICAgICAgIGhlYWRpbmc6IGZ1bmN0aW9uKG1ldGFEYXRhKSB7XG4gICAgICAgICAgaWYgKG1ldGFEYXRhLmFic3RyYWN0U3VtbWFyeSkge1xuICAgICAgICAgICAgcmV0dXJuIG1ldGFEYXRhLmFic3RyYWN0U3VtbWFyeTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICdObyBIZWFkaW5nJztcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgZGF0ZUZyb21Mb25nOiBmdW5jdGlvbihsb25nRGF0ZSkge1xuICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShsb25nRGF0ZSkudG9EYXRlU3RyaW5nKCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgaXRlbXNGb3JTZWxlY3Rpb246IGZ1bmN0aW9uKGl0ZW1zRm9yU2VsZWN0aW9uKSB7XG4gICAgICAgICAgdmFyIHIgPSB0aGlzO1xuICAgICAgICAgIGl0ZW1zRm9yU2VsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2l0ZW1Gb3JTZWxlY3Rpb246ICcsIHIuZ2V0TWVkaWFJdGVtUmVmZXJlbmNlQXQoaXRlbS5tZWRpYUl0ZW1zWzBdLCAwKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgc2VsZWN0ZWRDaGFuZ2VkOiBmdW5jdGlvbihjaCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdjaDogJywgY2gpO1xuICAgICAgICAgIGlmIChjaC5wYXRoID09PSAnc2VsdGQubGVuZ3RoJykge1xuICAgICAgICAgICAgdGhpcy5oYXNTZWxlY3Rpb24gPSBjaC52YWx1ZSA+IDA7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IGNoLmJhc2U7XG4gICAgICAgICAgICB0aGlzLnNob3dTZWxlY3Rpb24gPSB0aGlzLmhhc1NlbGVjdGlvbjtcbiAgICAgICAgICAgIHRoaXMuZmlyZSgnaXJvbi1zaWduYWwnLCB7bmFtZTogJ3NlbGVjdGlvbi1jaGFuZ2VkJywgZGF0YTogZGF0YX0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICBzZWFyY2hMb2FkaW5nQ2hhbmdlZDogZnVuY3Rpb24oZSkge1xuICAgICAgICAgIGlmICghZS5kZXRhaWwubG9hZGluZykge1xuICAgICAgICAgICAgdGhpcy5zZXQoJ19pbWFnZUFydGljbGVzJywgdGhpcy5faW1hZ2VzRnJvbUFydGljbGVzKHRoaXMuYXJ0aWNsZXMpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2ltYWdlc0Zyb21BcnRpY2xlczogZnVuY3Rpb24oYXJ0aWNsZXMpIHtcbiAgICAgICAgICB2YXIgYWxsSW1hZ2VzID0gW107XG4gICAgICAgICAgYXJ0aWNsZXMuZm9yRWFjaChmdW5jdGlvbihhcnRpY2xlKSB7XG4gICAgICAgICAgICBhbGxJbWFnZXMgPSBfLmNvbmNhdChhbGxJbWFnZXMsIHRoaXMuX2ZpbHRlclR5cGUoYXJ0aWNsZSwgJ0ltYWdlJykpO1xuICAgICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgICAgICAgcmV0dXJuIGFsbEltYWdlcztcbiAgICAgICAgfSxcblxuICAgICAgICBfZmlsdGVyVHlwZTogZnVuY3Rpb24oYXJ0aWNsZSwgbWVkaWFUeXBlKSB7XG5cbiAgICAgICAgICBpZiAoYXJ0aWNsZS5tZWRpYUl0ZW1zID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyAubWVkaWFJdGVtc1xuXG4gICAgICAgICAgY29uc29sZS5sb2coJ21lZGlhSXRlbXM6ICcsIGFydGljbGUubWVkaWFJdGVtcy5sZW5ndGgpO1xuXG4gICAgICAgICAgdmFyIGZvckNvbGxlY3Rpb24gPSBfLmN1cnJ5KGZ1bmN0aW9uKGJ1Y2tldCwgaXRlbSkge1xuICAgICAgICAgICAgaWYgKF8uaXNFcXVhbChpdGVtLm1lZGlhVHlwZSwgbWVkaWFUeXBlKSkge1xuICAgICAgICAgICAgICBpdGVtLm1ldGFEYXRhID0gYXJ0aWNsZS5tZXRhRGF0YTtcbiAgICAgICAgICAgICAgdmFyIGltZ1JlZiA9IHRoaXMuZ2V0TWVkaWFJdGVtUmVmZXJlbmNlQXQoaXRlbSwgMCk7XG5cbiAgICAgICAgICAgICAgaWYgKGltZ1JlZi5pbWFnZVVSTCAhPT0gdW5kZWZpbmVkICYmIGltZ1JlZi5pbWFnZVVSTC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgYnVja2V0LnB1c2goaXRlbSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdubyBpbWdVUkwgaW4gaW1nUmVmOiAnLCBpbWdSZWYpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICAgICAgICAgIHZhciBpbWFnZUl0ZW1zID0gW107XG4gICAgICAgICAgYXJ0aWNsZS5tZWRpYUl0ZW1zLmZvckVhY2goZm9yQ29sbGVjdGlvbihpbWFnZUl0ZW1zKSk7XG5cbiAgICAgICAgICByZXR1cm4gaW1hZ2VJdGVtcztcbiAgICAgICAgfSxcblxuICAgICAgICBfc2hvd0ltYWdlRGV0YWlsczogZnVuY3Rpb24oZSkge1xuICAgICAgICAgIHRoaXMuJC5tZXRhRGlhbG9nLmRpc3BsYXlGb3IoZS5kZXRhaWwpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
