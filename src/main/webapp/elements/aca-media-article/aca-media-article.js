'use strict';

(function () {
  'use strict';

  Polymer({
    is: 'aca-media-article',

    properties: {
      contentKey: {
        type: String,
        value: undefined
      },

      article: {
        type: Object,
        value: undefined
      },

      fields: {
        type: Array,
        value: []
      },

      media: {
        type: Array,
        value: []
      },

      _hasMedia: {
        type: Boolean,
        value: false,
        notify: true
      }

    },

    audioImage: function audioImage() {
      return 'images/sonata.png';
    },

    lookup: function lookup(contentKey) {
      if (_.hasIn(app, 'params.contentKey')) {
        this.set('contentKey', app.params.contentKey);
      } else if (contentKey) {
        page.redirect('/article/' + contentKey);
        return;
      } else {
        console.warn('Could not get contentKey from either parameter or path.');
        return;
      }

      console.debug('lookup: ', this.contentKey);
      this.contentKeyChanged(this.contentKey);
    },

    contentKeyChanged: function contentKeyChanged(newContentKey) {
      app.showToast('new contentKey: {contentKey}', { contentKey: newContentKey });

      this.reset();

      app.lookup(newContentKey, function (response) {
        console.info('Got lookup response: ', response);

        this.article = response.data.content[0].article;
        this.metaData = response.data.content[0].article.metaData;

        var urlForReference = function urlForReference(mediaItem) {
          if (mediaItem.mediaType === 'Image') {
            return mediaItem.references[0].imageURL;
          } else if (mediaItem.mediaType === 'Audio') {
            return mediaItem.references[0].url;
          } else if (mediaItem.mediaType === 'Video') {
            return mediaItem.references[0].url;
          }
        };

        var pushToMedia = function pushToMedia(host) {
          return function (mediaItem) {
            console.info('pushTomedia: host: %o', host);
            if (!_.isEmpty(mediaItem.references)) {
              var item = {
                caption: mediaItem.caption,
                type: mediaItem.mediaType,
                url: urlForReference(mediaItem)
              };
              console.info('pushing media item: ', item);
              host.push('media', item);
            }
          };
        };

        var pushToTuple = function pushToTuple(host) {
          return function (key) {
            console.info('pushToTuple: host: %o, key: %s', host, key);

            var value = host.article[key];

            if (value !== undefined && value !== null && !_.isEmpty(value)) {
              host.push('fields', { key: key, value: value });
              if ('mediaList' === key) {
                _.each(value.mediaItems, pushToMedia(host));
              }
            }
          };
        };

        _.keys(this.article).forEach(pushToTuple(this));

        this.set('_hasMedia', !_.isEmpty(this.media));
      }.bind(this), function (err) {
        app.showToast('Error during lookup: {err}', { err: err }, true);
      });
    },

    reset: function reset() {
      this.article = undefined;
      this.fields = [];
      this.media = [];
      this._hasMedia = false;
    },

    togglePlay: function togglePlay(e) {
      var audioPlayer = Polymer.dom(e.target.parentNode).querySelector('audio');
      console.log('toggle audio play: ', audioPlayer);

      if (audioPlayer.paused) {
        audioPlayer.play();
      } else {
        audioPlayer.pause();
      }
    },

    onTogglePlay: function onTogglePlay(e) {

      var stylePauseIcon = 'av:pause-circle-outline';
      var stylePlayIcon = 'av:play-circle-outline';
      var mediaControlId = '#mediaControl';
      var mediaButtonId = 'paper-icon-button#mediaButton';

      var findNodeUp = function findNodeUp(id, node) {
        var traverseUp = function traverseUp(node) {
          if (node.parentNode === null) {
            return null;
          } else {
            return node.id === id ? node : traverseUp(node.parentNode);
          }
        };
        return traverseUp(node);
      };

      var toggleSteps = function toggleSteps(control, button) {
        if (!(control && button)) {
          console.error('Both control and button is required.');
          return;
        }

        if (control.paused) {
          control.play();
        } else {
          control.pause();
        }
        Polymer.dom(button).setAttribute('icon', control.paused ? stylePlayIcon : stylePauseIcon);
      };

      var mediaContainer = findNodeUp('mediaContainer', e.target);

      if (mediaContainer) {
        var mediaControl = Polymer.dom(mediaContainer).querySelector(mediaControlId);
        var mediaButton = Polymer.dom(mediaContainer).querySelector(mediaButtonId);
        toggleSteps(mediaControl, mediaButton);
      }
    },

    _isType: function _isType(item, type) {
      return item.type === type;
    },

    _isAudioOrVideo: function _isAudioOrVideo(item) {
      return _.some(['Audio', 'Video'], function (t) {
        return t === item.type;
      });
    },

    _isImage: function _isImage(item) {
      return this._isType(item, 'Image');
    },

    _isAudio: function _isAudio(item) {
      return this._isType(item, 'Audio');
    },

    _isVideo: function _isVideo(item) {
      return this._isType(item, 'Video');
    }

  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnRzL2FjYS1tZWRpYS1hcnRpY2xlL2FjYS1tZWRpYS1hcnRpY2xlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsQ0FBQyxZQUFXO0FBQ047O0FBRUEsVUFBUTtBQUNOLFFBQUksbUJBREU7O0FBR04sZ0JBQVk7QUFDVixrQkFBWTtBQUNWLGNBQU0sTUFESTtBQUVWLGVBQU87QUFGRyxPQURGOztBQU9WLGVBQVM7QUFDUCxjQUFNLE1BREM7QUFFUCxlQUFPO0FBRkEsT0FQQzs7QUFZVixjQUFRO0FBQ04sY0FBTSxLQURBO0FBRU4sZUFBTztBQUZELE9BWkU7O0FBaUJWLGFBQU87QUFDTCxjQUFNLEtBREQ7QUFFTCxlQUFPO0FBRkYsT0FqQkc7O0FBc0JWLGlCQUFXO0FBQ1QsY0FBTSxPQURHO0FBRVQsZUFBTyxLQUZFO0FBR1QsZ0JBQVE7QUFIQzs7QUF0QkQsS0FITjs7QUFpQ04sZ0JBQVksc0JBQVc7QUFDckIsYUFBTyxtQkFBUDtBQUNELEtBbkNLOztBQXFDTixZQUFRLGdCQUFTLFVBQVQsRUFBcUI7QUFDM0IsVUFBSSxFQUFFLEtBQUYsQ0FBUSxHQUFSLEVBQWEsbUJBQWIsQ0FBSixFQUF1QztBQUNyQyxhQUFLLEdBQUwsQ0FBUyxZQUFULEVBQXVCLElBQUksTUFBSixDQUFXLFVBQWxDO0FBQ0QsT0FGRCxNQUVPLElBQUksVUFBSixFQUFnQjtBQUNyQixhQUFLLFFBQUwsQ0FBYyxjQUFjLFVBQTVCO0FBQ0E7QUFDRCxPQUhNLE1BR0E7QUFDTCxnQkFBUSxJQUFSLENBQWEseURBQWI7QUFDQTtBQUNEOztBQUVELGNBQVEsS0FBUixDQUFjLFVBQWQsRUFBMEIsS0FBSyxVQUEvQjtBQUNBLFdBQUssaUJBQUwsQ0FBdUIsS0FBSyxVQUE1QjtBQUNELEtBbERLOztBQW9ETix1QkFBbUIsMkJBQVMsYUFBVCxFQUF3QjtBQUN6QyxVQUFJLFNBQUosQ0FBYyw4QkFBZCxFQUE4QyxFQUFDLFlBQVksYUFBYixFQUE5Qzs7QUFFQSxXQUFL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QVpEOztBQWNBLFVBQU0saUJBQWlCLFdBQVcsZ0JBQVgsRUFBNkIsRUFBRSxNQUEvQixDQUF2Qjs7QUFFQSxVQUFJLGNBQUosRUFBb0I7QUFDbEIsWUFBTSxlQUFlLFFBQVEsR0FBUixDQUFZLGNBQVosRUFBNEIsYUFBNUIsQ0FBMEMsY0FBMUMsQ0FBckI7QUFDQSxZQUFNLGNBQWMsUUFBUSxHQUFSLENBQVksY0FBWixFQUE0QixhQUE1QixDQUEwQyxhQUExQyxDQUFwQjtBQUNBLG9CQUFZLFlBQVosRUFBMEIsV0FBMUI7QUFDRDtBQUNGLEtBdEtLOztBQXdLTixhQUFTLGlCQUFTLElBQVQsRUFBZSxJQUFmLEVBQXFCO0FBQzVCLGFBQU8sS0FBSyxJQUFMLEtBQWMsSUFBckI7QUFDRCxLQTFLSzs7QUE0S04scUJBQWlCLHlCQUFTLElBQVQsRUFBZTtBQUM5QixhQUFPLEVBQUUsSUFBRixDQUFPLENBQUMsT0FBRCxFQUFTLE9BQVQsQ0FBUCxFQUEwQixVQUFTLENBQVQsRUFBWTtBQUMzQyxlQUFPLE1BQU0sS0FBSyxJQUFsQjtBQUNELE9BRk0sQ0FBUDtBQUdELEtBaExLOztBQWtMTixjQUFVLGtCQUFTLElBQVQsRUFBZTtBQUN2QixhQUFPLEtBQUssT0FBTCxDQUFhLElBQWIsRUFBbUIsT0FBbkIsQ0FBUDtBQUNELEtBcExLOztBQXNMTixjQUFVLGtCQUFTLElBQVQsRUFBZTtBQUN2QixhQUFPLEtBQUssT0FBTCxDQUFhLElBQWIsRUFBbUIsT0FBbkIsQ0FBUDtBQUNELEtBeExLOztBQTBMTixjQUFVLGtCQUFTLElBQVQsRUFBZTtBQUN2QixhQUFPLEtBQUssT0FBTCxDQUFhLElBQWIsRUFBbUIsT0FBbkIsQ0FBUDtBQUNEOztBQTVMSyxHQUFSO0FBK0xELENBbE1MIiwiZmlsZSI6ImVsZW1lbnRzL2FjYS1tZWRpYS1hcnRpY2xlL2FjYS1tZWRpYS1hcnRpY2xlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCkge1xuICAgICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgICBQb2x5bWVyKHtcbiAgICAgICAgaXM6ICdhY2EtbWVkaWEtYXJ0aWNsZScsXG5cbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIGNvbnRlbnRLZXk6IHtcbiAgICAgICAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgICAgICAgIHZhbHVlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAvL29ic2VydmVyOiAnY29udGVudEtleUNoYW5nZWQnXG4gICAgICAgICAgfSxcblxuICAgICAgICAgIGFydGljbGU6IHtcbiAgICAgICAgICAgIHR5cGU6IE9iamVjdCxcbiAgICAgICAgICAgIHZhbHVlOiB1bmRlZmluZWRcbiAgICAgICAgICB9LFxuXG4gICAgICAgICAgZmllbGRzOiB7XG4gICAgICAgICAgICB0eXBlOiBBcnJheSxcbiAgICAgICAgICAgIHZhbHVlOiBbXVxuICAgICAgICAgIH0sXG5cbiAgICAgICAgICBtZWRpYToge1xuICAgICAgICAgICAgdHlwZTogQXJyYXksXG4gICAgICAgICAgICB2YWx1ZTogW11cbiAgICAgICAgICB9LFxuXG4gICAgICAgICAgX2hhc01lZGlhOiB7XG4gICAgICAgICAgICB0eXBlOiBCb29sZWFuLFxuICAgICAgICAgICAgdmFsdWU6IGZhbHNlLFxuICAgICAgICAgICAgbm90aWZ5OiB0cnVlXG4gICAgICAgICAgfVxuXG4gICAgICAgIH0sXG5cbiAgICAgICAgYXVkaW9JbWFnZTogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuICdpbWFnZXMvc29uYXRhLnBuZyc7XG4gICAgICAgIH0sXG5cbiAgICAgICAgbG9va3VwOiBmdW5jdGlvbihjb250ZW50S2V5KSB7XG4gICAgICAgICAgaWYgKF8uaGFzSW4oYXBwLCAncGFyYW1zLmNvbnRlbnRLZXknKSkge1xuICAgICAgICAgICAgdGhpcy5zZXQoJ2NvbnRlbnRLZXknLCBhcHAucGFyYW1zLmNvbnRlbnRLZXkpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoY29udGVudEtleSkge1xuICAgICAgICAgICAgcGFnZS5yZWRpcmVjdCgnL2FydGljbGUvJyArIGNvbnRlbnRLZXkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ0NvdWxkIG5vdCBnZXQgY29udGVudEtleSBmcm9tIGVpdGhlciBwYXJhbWV0ZXIgb3IgcGF0aC4nKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zb2xlLmRlYnVnKCdsb29rdXA6ICcsIHRoaXMuY29udGVudEtleSk7XG4gICAgICAgICAgdGhpcy5jb250ZW50S2V5Q2hhbmdlZCh0aGlzLmNvbnRlbnRLZXkpO1xuICAgICAgICB9LFxuXG4gICAgICAgIGNvbnRlbnRLZXlDaGFuZ2VkOiBmdW5jdGlvbihuZXdDb250ZW50S2V5KSB7XG4gICAgICAgICAgYXBwLnNob3dUb2FzdCgnbmV3IGNvbnRlbnRLZXk6IHtjb250ZW50S2V5fScsIHtjb250ZW50S2V5OiBuZXdDb250ZW50S2V5fSk7XG5cbiAgICAgICAgICB0aGlzLnJlc2V0KCk7XG5cbiAgICAgICAgICBhcHAubG9va3VwKG5ld0NvbnRlbnRLZXksIGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oJ0dvdCBsb29rdXAgcmVzcG9uc2U6ICcsIHJlc3BvbnNlKTtcblxuICAgICAgICAgICAgdGhpcy5hcnRpY2xlID0gcmVzcG9uc2UuZGF0YS5jb250ZW50WzBdLmFydGljbGU7XG4gICAgICAgICAgICB0aGlzLm1ldGFEYXRhID0gcmVzcG9uc2UuZGF0YS5jb250ZW50WzBdLmFydGljbGUubWV0YURhdGE7XG5cbiAgICAgICAgICAgIGNvbnN0IHVybEZvclJlZmVyZW5jZSA9IChtZWRpYUl0ZW0pID0+IHtcbiAgICAgICAgICAgICAgaWYgKG1lZGlhSXRlbS5tZWRpYVR5cGUgPT09ICdJbWFnZScpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbWVkaWFJdGVtLnJlZmVyZW5jZXNbMF0uaW1hZ2VVUkw7XG4gICAgICAgICAgICAgIH0gZWxzZSBpZiAobWVkaWFJdGVtLm1lZGlhVHlwZSA9PT0gJ0F1ZGlvJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBtZWRpYUl0ZW0ucmVmZXJlbmNlc1swXS51cmw7XG4gICAgICAgICAgICAgIH0gZWxzZSBpZiAobWVkaWFJdGVtLm1lZGlhVHlwZSA9PT0gJ1ZpZGVvJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBtZWRpYUl0ZW0ucmVmZXJlbmNlc1swXS51cmw7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IHB1c2hUb01lZGlhID0gaG9zdCA9PiAobWVkaWFJdGVtKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuaW5mbygncHVzaFRvbWVkaWE6IGhvc3Q6ICVvJywgaG9zdCk7XG4gICAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KG1lZGlhSXRlbS5yZWZlcmVuY2VzKSkge1xuICAgICAgICAgICAgICAgIGxldCBpdGVtID0ge1xuICAgICAgICAgICAgICAgICAgY2FwdGlvbjogbWVkaWFJdGVtLmNhcHRpb24sXG4gICAgICAgICAgICAgICAgICB0eXBlOiBtZWRpYUl0ZW0ubWVkaWFUeXBlLFxuICAgICAgICAgICAgICAgICAgdXJsOiB1cmxGb3JSZWZlcmVuY2UobWVkaWFJdGVtKVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCdwdXNoaW5nIG1lZGlhIGl0ZW06ICcsIGl0ZW0pO1xuICAgICAgICAgICAgICAgIGhvc3QucHVzaCgnbWVkaWEnLCBpdGVtKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgcHVzaFRvVHVwbGUgPSBob3N0ID0+IChrZXkpID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCdwdXNoVG9UdXBsZTogaG9zdDogJW8sIGtleTogJXMnLCBob3N0LCBrZXkpO1xuXG4gICAgICAgICAgICAgIGxldCB2YWx1ZSA9IGhvc3QuYXJ0aWNsZVtrZXldO1xuXG4gICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsICYmICFfLmlzRW1wdHkodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgaG9zdC5wdXNoKCdmaWVsZHMnLCB7a2V5OiBrZXksIHZhbHVlOiB2YWx1ZX0pO1xuICAgICAgICAgICAgICAgIGlmICgnbWVkaWFMaXN0JyA9PT0ga2V5KSB7XG4gICAgICAgICAgICAgICAgICBfLmVhY2godmFsdWUubWVkaWFJdGVtcywgcHVzaFRvTWVkaWEoaG9zdCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgXy5rZXlzKHRoaXMuYXJ0aWNsZSkuZm9yRWFjaChwdXNoVG9UdXBsZSh0aGlzKSk7XG5cbiAgICAgICAgICAgIHRoaXMuc2V0KCdfaGFzTWVkaWEnLCAhXy5pc0VtcHR5KHRoaXMubWVkaWEpKTtcblxuICAgICAgICAgIH0uYmluZCh0aGlzKSwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBhcHAuc2hvd1RvYXN0KCdFcnJvciBkdXJpbmcgbG9va3VwOiB7ZXJyfScsIHtlcnI6IGVycn0sIHRydWUpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0sXG5cbiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHRoaXMuYXJ0aWNsZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB0aGlzLmZpZWxkcyA9IFtdO1xuICAgICAgICAgIHRoaXMubWVkaWEgPSBbXTtcbiAgICAgICAgICB0aGlzLl9oYXNNZWRpYSA9IGZhbHNlO1xuICAgICAgICB9LFxuXG4gICAgICAgIHRvZ2dsZVBsYXk6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICB2YXIgYXVkaW9QbGF5ZXIgPSBQb2x5bWVyLmRvbShlLnRhcmdldC5wYXJlbnROb2RlKS5xdWVyeVNlbGVjdG9yKCdhdWRpbycpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCd0b2dnbGUgYXVkaW8gcGxheTogJywgYXVkaW9QbGF5ZXIpO1xuXG4gICAgICAgICAgaWYgKGF1ZGlvUGxheWVyLnBhdXNlZCkge1xuICAgICAgICAgICAgYXVkaW9QbGF5ZXIucGxheSgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhdWRpb1BsYXllci5wYXVzZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICBvblRvZ2dsZVBsYXk6IGZ1bmN0aW9uKGUpIHtcblxuICAgICAgICAgIGNvbnN0IHN0eWxlUGF1c2VJY29uID0gJ2F2OnBhdXNlLWNpcmNsZS1vdXRsaW5lJztcbiAgICAgICAgICBjb25zdCBzdHlsZVBsYXlJY29uID0gJ2F2OnBsYXktY2lyY2xlLW91dGxpbmUnO1xuICAgICAgICAgIGNvbnN0IG1lZGlhQ29udHJvbElkID0gJyNtZWRpYUNvbnRyb2wnO1xuICAgICAgICAgIGNvbnN0IG1lZGlhQnV0dG9uSWQgPSAncGFwZXItaWNvbi1idXR0b24jbWVkaWFCdXR0b24nO1xuXG4gICAgICAgICAgY29uc3QgZmluZE5vZGVVcCA9IChpZCwgbm9kZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdHJhdmVyc2VVcCA9IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKG5vZGUuaWQgPT09IGlkKSA/IG5vZGUgOiB0cmF2ZXJzZVVwKG5vZGUucGFyZW50Tm9kZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gdHJhdmVyc2VVcChub2RlKTtcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgY29uc3QgdG9nZ2xlU3RlcHMgPSAoY29udHJvbCwgYnV0dG9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoIShjb250cm9sICYmIGJ1dHRvbikpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignQm90aCBjb250cm9sIGFuZCBidXR0b24gaXMgcmVxdWlyZWQuJyk7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbnRyb2wucGF1c2VkKSB7XG4gICAgICAgICAgICAgIGNvbnRyb2wucGxheSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29udHJvbC5wYXVzZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgUG9seW1lci5kb20oYnV0dG9uKS5zZXRBdHRyaWJ1dGUoJ2ljb24nLCAoY29udHJvbC5wYXVzZWQgPyBzdHlsZVBsYXlJY29uIDogc3R5bGVQYXVzZUljb24gICkpO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICBjb25zdCBtZWRpYUNvbnRhaW5lciA9IGZpbmROb2RlVXAoJ21lZGlhQ29udGFpbmVyJywgZS50YXJnZXQpO1xuXG4gICAgICAgICAgaWYgKG1lZGlhQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBjb25zdCBtZWRpYUNvbnRyb2wgPSBQb2x5bWVyLmRvbShtZWRpYUNvbnRhaW5lcikucXVlcnlTZWxlY3RvcihtZWRpYUNvbnRyb2xJZCk7XG4gICAgICAgICAgICBjb25zdCBtZWRpYUJ1dHRvbiA9IFBvbHltZXIuZG9tKG1lZGlhQ29udGFpbmVyKS5xdWVyeVNlbGVjdG9yKG1lZGlhQnV0dG9uSWQpO1xuICAgICAgICAgICAgdG9nZ2xlU3RlcHMobWVkaWFDb250cm9sLCBtZWRpYUJ1dHRvbik7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIF9pc1R5cGU6IGZ1bmN0aW9uKGl0ZW0sIHR5cGUpIHtcbiAgICAgICAgICByZXR1cm4gaXRlbS50eXBlID09PSB0eXBlO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9pc0F1ZGlvT3JWaWRlbzogZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgIHJldHVybiBfLnNvbWUoWydBdWRpbycsJ1ZpZGVvJ10sIGZ1bmN0aW9uKHQpIHtcbiAgICAgICAgICAgIHJldHVybiB0ID09PSBpdGVtLnR5cGU7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2lzSW1hZ2U6IGZ1bmN0aW9uKGl0ZW0pIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5faXNUeXBlKGl0ZW0sICdJbWFnZScpO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9pc0F1ZGlvOiBmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2lzVHlwZShpdGVtLCAnQXVkaW8nKTtcbiAgICAgICAgfSxcblxuICAgICAgICBfaXNWaWRlbzogZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLl9pc1R5cGUoaXRlbSwgJ1ZpZGVvJyk7XG4gICAgICAgIH0sXG5cbiAgICAgIH0pO1xuICAgIH0pKCk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
